<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maze of Echoes</title>
        <link rel="icon" type="png" href="/images/WebMaze-of-EchoesLogo.png">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* ------------------------- */
        /* --- GENERAL STYLE & RESET --- */
        /* ------------------------- */
        :root {
            --color-bg: #03000a;
            --color-wall: #1a0a2f;
            --color-path: #0a0218;
            --color-p1: #00ffff; /* Neon Cyan */
            --color-p1-glow: rgba(0, 255, 255, 0.7);
            --color-p2: #ff00ff; /* Neon Magenta */
            --color-p2-glow: rgba(255, 0, 255, 0.7);
            --color-goal: #ffff00; /* Neon Yellow */
            --color-goal-glow: rgba(255, 255, 0, 0.7);
            --color-text: #e0e0e0;
            
            --cell-size: 35px; /* Cell Size */
            
            /* Variables for "Fog of War" (controlled by JS) */
            --p1-light-x: 50%;
            --p1-light-y: 50%;
            --p1-radius-scale: 1;
            
            --p2-light-x: 50%;
            --p2-light-y: 50%;
            --p2-radius-scale: 1;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background-color: var(--color-bg);
            color: var(--color-text);
            font-family: 'Orbitron', sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            overflow: hidden;
            perspective: 1000px; /* For 3D effects */
        }

        h1, h2 {
            text-shadow: 0 0 10px var(--color-p1-glow), 0 0 20px var(--color-p1-glow);
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        /* ------------------------- */
        /* --- MENU & UI --- */
        /* ------------------------- */
        #main-menu {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            text-align: center;
            transform: translateZ(0); /* Fix flickering */
        }

        #main-menu h1 {
            font-size: 3rem;
            color: var(--color-p1);
            animation: flicker 3s infinite alternate;
        }

        .menu-button {
            font-family: 'Orbitron', sans-serif;
            background: transparent;
            border: 2px solid var(--color-p1);
            color: var(--color-p1);
            padding: 15px 30px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 15px var(--color-p1-glow) inset, 0 0 5px var(--color-p1-glow);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .menu-button:hover {
            background: var(--color-p1-glow);
            color: var(--color-bg);
            box-shadow: 0 0 25px var(--color-p1-glow), 0 0 10px var(--color-p1-glow) inset;
        }

        #game-container {
            display: none; /* Hidden initially */
            width: 100%;
            height: 100vh; /* Fills the screen */
        }

        #split-screen-container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        /* Stable layout for 1P */
        #player1-view.single-player {
            width: 100%;
            height: 100%;
        }

        /* Split-screen layout */
        #player1-view, #player2-view {
            flex-basis: 50%;
            height: 100%;
            position: relative;
            overflow: hidden;
            border: 1px solid #444; /* Separator */
        }
        
        /* UI Messages (Level, Win) */
        .game-ui-overlay {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            font-size: 1.5rem;
            text-shadow: 0 0 10px #fff;
            pointer-events: none;
        }
        #p1-ui { color: var(--color-p1); }
        #p2-ui { color: var(--color-p2); }

        #message-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none; /* Hidden */
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 25px;
            z-index: 200;
            text-align: center;
        }
        
        #message-screen h2 {
            font-size: 2.5rem;
        }
        
        #message-screen .menu-button {
            border-color: var(--color-goal);
            color: var(--color-goal);
            box-shadow: 0 0 15px var(--color-goal-glow) inset, 0 0 5px var(--color-goal-glow);
        }
        
        #message-screen .menu-button:hover {
             background: var(--color-goal-glow);
             color: var(--color-bg);
             box-shadow: 0 0 25px var(--color-goal-glow), 0 0 10px var(--color-goal-glow) inset;
        }

        /* ------------------------- */
        /* --- GAME SCENERY --- */
        /* ------------------------- */
        
        .game-wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-bg);
            /* transform-style is crucial for z-indexing */
            transform-style: preserve-3d;
            position: relative;
        }
        
        .grid-container {
            position: relative;
            display: grid;
            border: 2px solid var(--color-wall);
            box-shadow: 0 0 20px #000 inset;
            /* 3D effect to look "deep" */
            transform: rotateX(10deg) scale(1.1);
        }

        .cell {
            width: var(--cell-size);
            height: var(--cell-size);
            background-color: var(--color-path);
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        .wall {
            background-color: var(--color-wall);
            box-shadow: 0 0 10px rgba(0,0,0,0.5) inset, 0 0 5px var(--color-wall);
            /* Light 3D appearance */
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            border-left: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .goal {
            background-color: var(--color-path);
            position: relative;
        }
        
        /* The goal is a glowing orb */
        .goal::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60%;
            height: 60%;
            background: var(--color-goal);
            border-radius: 50%;
            box-shadow: 0 0 15px var(--color-goal-glow), 0 0 25px var(--color-goal-glow);
            animation: pulse-goal 1.5s infinite alternate;
        }

        @keyframes pulse-goal {
            from {
                transform: translate(-50%, -50%) scale(0.9);
                opacity: 0.8;
                box-shadow: 0 0 15px var(--color-goal-glow), 0 0 25px var(--color-goal-glow);
            }
            to {
                transform: translate(-50%, -50%) scale(1.1);
                opacity: 1;
                box-shadow: 0 0 25px var(--color-goal-glow), 0 0 40px var(--color-goal-glow);
            }
        }

        /* ------------------------- */
        /* --- DYNAMIC DARKNESS (FOG) --- */
        /* ------------------------- */

        .fog-of-war {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Doesn't block mouse */
            z-index: 10;
            transform: translateZ(10px); /* Above the grid */
            
            /* Set by JS */
            --light-x: 50%;
            --light-y: 50%;
            --radius-scale: 1;
            
            --base-radius: 100px; /* Base light radius */
            --pulse-radius: calc(var(--base-radius) * var(--radius-scale));
            --fade-radius: calc(var(--pulse-radius) + 70px);
            
            background: radial-gradient(
                circle at var(--light-x) var(--light-y),
                transparent 0%,
                transparent var(--pulse-radius),
                rgba(3, 0, 10, 0.95) var(--fade-radius),
                var(--color-bg) calc(var(--fade-radius) + 50px)
            );
            
            animation: pulse-light 3s infinite ease-in-out;
        }
        
        /* .fog-of-war will get the player id (p1-fog, p2-fog) */
        #p1-fog {
            --light-x: var(--p1-light-x);
            --light-y: var(--p1-light-y);
            --radius-scale: var(--p1-radius-scale);
        }
        
        #p2-fog {
            --light-x: var(--p2-light-x);
            --light-y: var(--p2-light-y);
            --radius-scale: var(--p2-radius-scale);
        }

        @keyframes pulse-light {
            0%, 100% { --radius-scale: 1; }
            50% { --radius-scale: 1.05; }
        }

        /* ------------------------- */
        /* --- PLAYER & VFX --- */
        /* ------------------------- */
        
        .player {
            position: absolute;
            top: 0;
            left: 0;
            width: var(--cell-size);
            height: var(--cell-size);
            /* Movement is with transform for smoothness */
            transition: transform 0.1s linear;
            z-index: 5;
            transform: translateZ(5px); /* Above grid, below fog */
        }
        
        /* Visual "body" of the player */
        .player-avatar {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 60%;
            height: 60%;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: pulse-avatar 2s infinite;
        }

        #player1 .player-avatar {
            background: var(--color-p1);
            box-shadow: 0 0 15px var(--color-p1-glow), 0 0 25px var(--color-p1-glow);
        }
        
        #player2 .player-avatar {
            background: var(--color-p2);
            box-shadow: 0 0 15px var(--color-p2-glow), 0 0 25px var(--color-p2-glow);
        }

        @keyframes pulse-avatar {
            0% { opacity: 0.8; }
            50% { opacity: 1; }
            100% { opacity: 0.8; }
        }
        
        /* Particle (common class) */
        .particle {
            position: absolute;
            border-radius: 50%;
            pointer-events: none;
            z-index: 11; /* Above fog */
            transform: translateZ(11px);
        }
        
        /* 1. Step Particle (VFX) */
        .step-particle {
            width: 5px;
            height: 5px;
            animation: particle-move 0.6s ease-out forwards;
        }

        @keyframes particle-move {
            0% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            100% {
                /* Random movement */
                transform: translate(calc(var(--dx, 0) * 1px - 50%), calc(var(--dy, 0) * 1px - 50%)) scale(0);
                opacity: 0;
            }
        }
        
        /* 2. Glow Trail */
        .glow-trail {
            width: 10px;
            height: 10px;
            opacity: 0.5;
            animation: fade-out 0.8s linear forwards;
        }

        @keyframes fade-out {
            to {
                opacity: 0;
                transform: scale(0.5);
            }
        }
        
        /* 3. Collision Spark */
        .spark-particle {
            width: 4px;
            height: 10px; /* Spark shape */
            border-radius: 2px;
            animation: spark-move 0.4s ease-out forwards;
        }
        
        @keyframes spark-move {
             0% {
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 1;
            }
            100% {
                transform: translate(calc(var(--dx, 0) * 1px - 50%), calc(var(--dy, 0) * 1px - 50%)) scale(0.1);
                opacity: 0;
            }
        }
        
        /* --- Animation Fades --- */
        @keyframes flicker {
            0%, 18%, 22%, 25%, 53%, 57%, 100% {
                text-shadow:
                0 0 8px var(--color-p1-glow),
                0 0 12px var(--color-p1-glow),
                0 0 20px var(--color-p1-glow),
                0 0 30px #00aaff,
                0 0 40px #00aaff;
            }
            20%, 24%, 55% {        
                text-shadow: none;
                opacity: 0.9;
            }
        }
        
        /* ------------------------- */
        /* --- RESPONSIVE (SPLIT-SCREEN) --- */
        /* ------------------------- */
        
        @media (max-width: 800px) {
            #split-screen-container {
                flex-direction: column; /* Column on mobile */
            }
            #player1-view, #player2-view {
                flex-basis: 50%;
                height: 50%;
            }
            
            :root {
                --cell-size: 25px; /* Smaller cells */
            }
            
            .game-ui-overlay {
                font-size: 1rem;
                top: 10px;
            }
            
             #main-menu h1 {
                font-size: 2rem;
            }
            
            .menu-button {
                padding: 10px 20px;
                font-size: 1rem;
            }
        }

    /* ------------------------- */
    /* --- MOBILE UNSUPPORTED MESSAGE --- */
    /* ------------------------- */
    #mobile-unsupported-message {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--color-bg); /* Σκούρο φόντο */
        display: none; /* ΚΡΥΦΟ ΕΞ ΟΡΙΣΜΟΥ. Θα εμφανιστεί μόνο από τη JS σε mobile. */
        align-items: center;
        justify-content: center;
        flex-direction: column;
        gap: 20px;
        z-index: 300; /* Πάνω από όλα τα άλλα */
        text-align: center;
        padding: 20px;
    }

    #mobile-unsupported-message h2 {
        font-size: 2rem;
        color: var(--color-p2); /* Neon Magenta για προσοχή */
        text-shadow: 0 0 10px var(--color-p2-glow), 0 0 20px var(--color-p2-glow);
        letter-spacing: 3px;
    }

    #mobile-unsupported-message p {
        font-size: 1.2rem;
        color: var(--color-text);
    }

    </style>
</head>
<body>

    <div id="main-menu">
        <h1>Maze of Echoes</h1>
        <p>Use WASD (Player 1) & Arrow Keys (Player 2)</p>
        <button id="start-1p" class="menu-button">1 Player</button>
        <button id="start-2p" class="menu-button">2 Players (Split-Screen)</button>
        <p style="font-size: 0.8rem; color: #777; margin-top: 20px; letter-spacing: 1px;">Powered by Greek Games Studios</p>
    </div>

    <div id="game-container">
        
        <div id="split-screen-container">
            
            <div id="player1-view" class="game-wrapper">
                <div id="p1-ui" class="game-ui-overlay">Level: 1</div>
                </div>
            
            <div id="player2-view" class="game-wrapper">
                 <div id="p2-ui" class="game-ui-overlay">Race!</div>
                </div>
            
        </div>
    </div>
    
    <div id="message-screen">
        <h2 id="message-title">CONGRATULATIONS!</h2>
        <p id="message-text">You completed the level!</p>
        <button id="next-level-button" class="menu-button">Next Level</button>
        <button id="play-again-button" class="menu-button">Play Again</button>
        <button id="main-menu-button" class="menu-button">Main Menu</button>
    </div>

    <div id="mobile-unsupported-message">
            <h2>MOBILE DEVICE NOT SUPPORTED</h2>
            <p>Please use a desktop computer (PC/Laptop) to play Maze of Echoes.</p>
            <p style="font-size: 0.8em; margin-top: 15px;">A keyboard is required to control the game.</p>
    </div>

    <script>
        // ------------------------- //
        // --- MAZE DATA (LEVELS) --- //
        // ------------------------- //
        // 0 = Path, 1 = Wall, 2 = Start, 3 = Goal
        
        // 30 unique mazes (15x11 grid)
        const MAZE_DATA = [
            // Level 1: Simple Path
            [
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
                [1,2,0,0,1,0,0,0,1,0,0,0,0,0,1],
                [1,0,1,0,1,0,1,0,1,0,1,1,1,0,1],
                [1,0,1,0,0,0,1,0,0,0,1,0,0,0,1],
                [1,0,1,1,1,1,1,1,1,0,1,0,1,1,1],
                [1,0,0,0,0,0,0,0,1,0,0,0,1,0,1],
                [1,1,1,1,1,0,1,0,1,1,1,1,1,0,1],
                [1,0,0,0,1,0,1,0,0,0,0,0,1,0,1],
                [1,0,1,0,1,0,1,1,1,1,1,0,1,0,1],
                [1,0,1,0,0,0,0,0,1,0,0,0,0,3,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
            ],
            // Level 2: Long Winding Corridor
            [
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
                [1,2,1,0,0,0,1,0,0,0,1,0,0,0,1],
                [1,0,0,0,1,0,1,0,1,0,1,0,1,0,1],
                [1,0,1,0,1,0,0,0,1,0,1,0,1,0,1],
                [1,0,0,0,1,1,1,1,1,0,1,1,1,0,1],
                [1,0,1,0,0,0,0,0,0,0,0,0,0,0,1],
                [1,0,1,1,1,1,1,0,1,1,1,1,1,0,1],
                [1,0,1,0,0,0,1,0,1,0,0,0,1,0,1],
                [1,0,1,0,1,0,1,0,0,0,1,0,1,1,1],
                [1,0,0,0,1,0,0,0,1,0,1,0,0,3,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
            ],
            // Level 3: Goal at Start
            [
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
                [1,3,0,1,0,0,0,1,0,0,0,1,0,0,1],
                [1,1,0,1,0,1,0,1,0,1,0,1,0,1,1],
                [1,0,0,0,0,1,0,0,0,1,0,0,0,0,1],
                [1,0,1,1,1,1,1,1,1,1,1,1,1,0,1],
                [1,0,0,0,0,0,0,0,0,0,0,0,1,0,1],
                [1,1,1,1,1,1,1,0,1,1,1,0,1,0,1],
                [1,0,0,0,0,0,1,0,1,0,1,0,1,0,1],
                [1,0,1,1,1,0,1,0,1,0,1,0,1,0,1],
                [1,0,0,0,1,0,0,0,1,0,0,0,1,2,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
            ],
            // Level 4: Central Hub
            [
                [1,2,0,0,0,0,1,0,0,0,0,0,0,0,1],
                [1,1,1,1,1,0,1,0,1,1,1,1,1,0,1],
                [1,0,0,0,1,0,1,0,1,0,0,0,1,0,1],
                [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1],
                [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1],
                [1,0,1,0,0,0,0,0,1,0,1,0,0,0,1],
                [1,0,1,1,1,1,1,1,1,0,1,1,1,1,1],
                [1,0,0,0,0,0,1,0,0,0,1,0,0,0,1],
                [1,1,1,1,1,0,1,0,1,1,1,0,1,0,1],
                [1,0,0,0,1,0,0,0,0,0,0,0,1,3,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
            ],
            // Level 5: Diagonal Path
            [
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
                [1,0,0,0,0,0,1,0,0,0,1,0,3,0,1],
                [1,0,1,1,1,0,1,0,1,0,1,0,1,0,1],
                [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1],
                [1,0,1,0,1,0,0,0,1,0,1,0,1,0,1],
                [1,0,1,0,1,1,1,1,1,0,1,1,1,0,1],
                [1,0,1,0,0,0,0,0,0,0,0,0,0,0,1],
                [1,0,1,1,1,1,1,1,1,1,1,1,1,0,1],
                [1,0,1,0,0,0,1,0,0,0,1,0,1,0,1],
                [1,2,0,0,1,0,1,0,1,0,1,0,0,0,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
            ],
            // Level 6: S-Shape
            [
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
                [1,2,0,0,0,0,0,0,0,0,0,0,0,0,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,0,1],
                [1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
                [1,0,1,1,1,1,1,1,1,1,1,1,1,1,1],
                [1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,0,1],
                [1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
                [1,0,1,1,1,1,1,1,1,1,1,1,1,1,1],
                [1,0,0,0,0,0,0,0,0,0,0,0,0,3,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
            ],
            // Level 7: Multiple dead ends
            [
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
                [1,2,0,1,0,0,0,1,0,1,0,0,0,0,1],
                [1,0,1,1,0,1,0,1,0,1,1,1,1,0,1],
                [1,0,0,0,0,1,0,1,0,0,0,0,1,0,1],
                [1,1,1,1,1,1,0,1,1,1,1,0,1,0,1],
                [1,0,0,0,0,0,0,0,0,0,1,0,1,0,1],
                [1,0,1,1,1,1,1,1,1,0,1,0,1,0,1],
                [1,0,0,0,0,0,0,0,1,0,0,0,1,0,1],
                [1,1,1,1,1,1,1,0,1,1,1,1,1,0,1],
                [1,0,0,0,0,0,0,0,0,0,0,0,0,3,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
            ],
            // Level 8: Checkerboard Start
            [
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
                [1,2,0,0,1,1,0,0,0,1,0,1,0,3,1],
                [1,0,1,0,0,0,0,1,0,0,0,0,1,0,1],
                [1,1,1,1,1,0,1,1,1,1,1,1,1,0,1],
                [1,0,0,0,0,0,0,0,0,0,1,0,0,0,1],
                [1,0,1,1,1,1,1,1,1,1,1,1,1,0,1],
                [1,0,0,0,0,0,1,0,0,0,0,0,0,0,1],
                [1,0,1,1,1,1,1,1,1,1,1,1,1,0,1],
                [1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,0,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
            ],
            // Level 9: Spiral Exit
            [
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
                [1,2,0,0,0,0,0,0,0,0,0,0,0,0,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,0,1],
                [1,0,0,0,0,0,0,0,0,0,0,0,1,0,1],
                [1,0,1,1,1,1,1,1,1,1,1,0,1,0,1],
                [1,0,1,0,0,0,0,0,0,0,1,0,0,0,1],
                [1,0,1,0,1,1,1,1,1,0,1,0,1,0,1],
                [1,0,1,0,1,0,0,0,1,0,1,0,1,0,1],
                [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1],
                [1,3,0,0,0,0,1,0,0,0,0,0,1,0,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
            ],
            // Level 10: Narrow ZigZag
            [
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
                [1,2,0,1,1,1,1,1,1,1,1,1,1,0,1],
                [1,1,0,1,0,0,0,0,0,0,0,0,1,0,1],
                [1,0,0,1,0,1,1,1,1,1,1,0,1,0,1],
                [1,0,1,1,0,1,0,0,0,0,1,0,1,0,1],
                [1,0,1,0,0,1,0,1,1,0,1,0,1,0,1],
                [1,0,1,0,1,1,0,1,0,0,1,0,1,0,1],
                [1,0,1,0,1,0,0,1,0,1,1,0,1,0,1],
                [1,0,1,0,1,0,1,1,0,0,0,0,0,0,1],
                [1,0,0,0,0,0,0,0,0,1,1,1,1,3,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
            ],
            // Level 11: Cross Shaped
            [
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
                [1,2,0,0,0,0,1,0,0,0,0,0,0,0,1],
                [1,1,1,1,1,0,1,0,1,1,1,1,1,0,1],
                [1,0,0,0,1,0,1,0,0,0,0,0,1,0,1],
                [1,0,1,0,1,0,0,0,1,0,1,0,1,0,1],
                [1,0,1,0,1,1,1,0,1,0,1,0,1,0,1],
                [1,0,1,0,0,0,0,0,1,0,0,0,1,0,1],
                [1,0,1,1,1,1,1,1,1,1,1,0,1,0,1],
                [1,0,0,0,0,0,1,0,0,0,1,0,0,0,1],
                [1,1,1,1,1,0,1,0,1,0,1,0,1,3,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
            ],
            // Level 12: Big Open Area
            [
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
                [1,2,0,0,0,0,0,0,0,0,1,0,0,3,1],
                [1,0,1,1,1,1,1,0,1,1,1,1,1,0,1],
                [1,0,1,0,0,0,0,0,0,0,1,0,0,0,1],
                [1,0,1,0,1,1,1,1,1,1,1,0,1,0,1],
                [1,0,1,0,1,0,0,0,0,0,1,0,1,1,1],
                [1,0,1,0,1,0,1,1,1,1,1,0,1,0,1],
                [1,0,1,0,1,0,1,0,0,0,1,0,1,0,1],
                [1,0,1,0,1,0,1,0,1,1,1,0,1,0,1],
                [1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
            ],
            // Level 13: Edge Hugger
            [
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
                [1,2,0,0,0,0,0,0,0,0,0,0,0,1,1],
                [1,0,1,0,1,1,1,1,1,0,1,1,1,0,1],
                [1,0,1,0,0,0,1,0,0,0,0,0,1,0,1],
                [1,0,1,0,1,1,1,1,1,1,1,0,1,0,1],
                [1,1,1,0,1,0,0,0,0,0,1,0,0,0,1],
                [1,0,1,0,1,0,1,1,1,0,1,0,1,0,1],
                [1,0,1,0,1,0,1,0,0,0,0,0,1,0,1],
                [1,0,1,0,1,0,1,0,1,1,1,0,1,0,1],
                [1,0,0,0,0,0,0,0,0,1,0,0,1,3,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
            ],
            // Level 14: Double Back
            [
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
                [1,2,0,0,0,1,0,0,0,1,0,0,0,1,1],
                [1,0,0,1,0,1,0,1,0,1,0,1,0,0,1],
                [1,1,0,1,0,0,0,1,0,0,0,1,1,0,1],
                [1,0,0,0,0,1,0,1,0,1,0,0,0,0,1],
                [1,0,1,1,1,1,0,1,1,1,1,1,1,1,1],
                [1,0,0,1,0,0,0,0,0,0,0,0,0,0,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,0,1],
                [1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
                [1,0,1,1,1,1,1,1,1,1,1,1,1,3,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
            ],
            // Level 15: Big Checkpoint
            [
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
                [1,2,0,0,0,0,0,1,0,0,0,0,0,0,1],
                [1,1,1,1,1,1,0,1,0,1,1,1,1,0,1],
                [1,0,0,0,0,0,0,1,0,1,0,0,0,0,1],
                [1,0,1,1,1,1,1,1,0,1,0,1,1,1,1],
                [1,0,0,0,0,0,0,0,0,1,0,0,0,0,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,0,1],
                [1,0,0,0,0,0,0,0,0,0,0,0,1,0,1],
                [1,0,1,1,1,1,1,1,1,1,1,0,1,0,1],
                [1,0,0,0,0,0,0,0,0,0,0,0,0,3,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
            ],
            // Level 16: H-Shape
            [
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
                [1,2,0,0,0,0,0,1,0,0,0,0,0,0,1],
                [1,1,1,1,1,1,0,1,0,1,1,1,1,1,1],
                [1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
                [1,0,1,1,1,1,1,1,1,1,1,1,1,0,1],
                [1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
                [1,1,1,1,1,1,0,1,1,1,1,1,1,1,1],
                [1,0,0,0,0,1,0,1,0,0,0,0,0,0,1],
                [1,0,1,1,0,1,0,1,0,1,1,1,1,1,1],
                [1,0,0,0,0,1,0,0,0,0,0,0,0,3,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
            ],
            // Level 17: U-Turn
            [
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
                [1,2,0,0,0,0,0,0,0,1,0,0,0,0,1],
                [1,1,1,1,1,0,1,1,1,1,1,1,1,0,1],
                [1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
                [1,1,1,1,1,1,1,1,1,1,0,1,1,1,1],
                [1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
                [1,1,1,0,1,1,1,1,1,1,1,1,1,1,1],
                [1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
                [1,0,1,1,1,1,1,1,1,1,1,1,1,1,1],
                [1,0,0,0,0,0,0,0,0,0,0,0,0,3,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
            ],
            // Level 18: Labyrinth (Hard)
            [
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
                [1,2,1,0,1,0,1,0,1,0,1,0,1,0,1],
                [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1],
                [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1],
                [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1],
                [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1],
                [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1],
                [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1],
                [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1],
                [1,0,0,0,0,0,0,0,0,0,0,0,0,3,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
            ],
            // Level 19: Long Wall
            [
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
                [1,2,0,0,0,0,0,0,0,0,0,0,1,0,1],
                [1,1,1,0,1,1,1,1,1,1,1,1,1,0,1],
                [1,0,0,0,0,0,0,0,0,0,0,0,1,0,1],
                [1,0,1,1,1,1,1,1,1,1,1,0,1,0,1],
                [1,0,1,0,0,0,0,0,0,0,1,0,1,0,1],
                [1,0,1,0,1,1,1,1,1,0,1,0,1,0,1],
                [1,0,1,0,1,0,0,0,1,0,1,0,0,0,1],
                [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1],
                [1,0,1,0,0,0,1,0,0,0,0,0,1,3,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
            ],
            // Level 20: T-Junctions
            [
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
                [1,2,0,0,1,0,0,1,0,0,0,1,0,0,1],
                [1,1,1,0,1,0,1,1,1,0,1,1,0,1,1],
                [1,0,0,0,0,0,1,0,0,0,0,0,0,0,1],
                [1,0,1,1,1,1,1,0,1,1,1,1,1,0,1],
                [1,0,0,0,0,0,0,0,0,0,0,0,1,0,1],
                [1,1,1,1,1,1,1,0,1,1,1,0,1,0,1],
                [1,0,0,0,0,0,1,0,1,0,1,0,1,0,1],
                [1,0,1,1,1,0,1,0,1,0,1,0,1,0,1],
                [1,0,0,0,1,0,0,0,1,0,0,0,1,3,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
            ],
            // Level 21: Reverse S-Shape
            [
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
                [1,0,0,0,0,0,0,0,0,0,0,0,0,3,1],
                [1,0,1,1,1,1,1,1,1,1,1,1,1,1,1],
                [1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,0,1],
                [1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
                [1,0,1,1,1,1,1,1,1,1,1,1,1,1,1],
                [1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,0,1],
                [1,2,0,0,0,0,0,0,0,0,0,0,0,0,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
            ],
            // Level 22: Boxed-in Goal
            [
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
                [1,2,0,0,0,0,1,0,0,0,0,0,0,0,1],
                [1,1,1,1,1,0,1,0,1,1,1,1,1,0,1],
                [1,0,0,0,1,0,1,0,1,0,0,0,1,0,1],
                [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1],
                [1,0,1,0,0,0,0,0,1,0,1,0,0,0,1],
                [1,0,1,1,1,1,1,1,1,0,1,1,1,1,1],
                [1,0,0,0,0,0,1,0,0,0,1,0,0,0,1],
                [1,1,1,1,1,0,1,0,1,1,1,0,1,0,1],
                [1,0,0,0,1,0,0,0,0,0,0,0,1,3,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
            ],
            // Level 23: Corner to Corner
            [
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
                [1,2,0,0,0,0,0,0,0,0,0,0,0,1,1],
                [1,0,1,1,1,1,1,1,1,1,1,0,1,0,1],
                [1,0,1,0,0,0,0,0,0,0,0,0,1,0,1],
                [1,0,1,0,1,1,1,1,1,1,1,0,1,0,1],
                [1,0,1,0,1,0,0,0,0,0,1,0,1,0,1],
                [1,0,1,0,1,0,1,1,1,0,1,0,1,0,1],
                [1,0,1,0,1,0,1,0,0,0,1,1,1,0,1],
                [1,0,1,0,1,0,1,0,1,1,1,0,1,0,1],
                [1,0,0,0,0,0,0,0,0,0,0,0,0,3,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
            ],
            // Level 24: Diamond Shape
            [
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
                [1,2,1,1,1,0,0,0,0,0,1,1,1,0,1],
                [1,0,0,0,1,0,1,1,1,0,1,0,1,0,1],
                [1,1,1,0,1,0,1,0,1,0,1,0,0,0,1],
                [1,0,0,0,1,0,1,0,1,0,1,0,1,0,1],
                [1,0,1,1,1,0,1,0,1,0,1,0,1,0,1],
                [1,0,0,0,0,0,1,0,1,0,0,0,1,1,1],
                [1,1,1,1,1,1,1,0,1,1,0,1,1,0,1],
                [1,0,0,0,1,0,0,0,0,0,0,0,0,0,1],
                [1,0,1,1,1,1,1,1,1,1,1,1,1,3,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
            ],
            // Level 25: Perimeter Walk
            [
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
                [1,2,0,1,0,0,0,0,0,0,0,0,0,0,1],
                [1,0,1,1,1,1,1,0,1,1,1,1,1,0,1],
                [1,0,1,0,0,0,0,0,0,0,0,0,1,0,1],
                [1,0,1,0,1,1,1,1,1,1,1,0,1,0,1],
                [1,0,1,0,1,0,0,0,0,0,1,1,1,0,1],
                [1,0,1,0,1,0,1,1,1,0,1,0,1,0,1],
                [1,0,1,0,1,0,1,0,0,0,0,0,1,0,1],
                [1,0,1,0,1,0,1,0,1,1,1,0,1,0,1],
                [1,0,0,0,0,0,0,0,0,0,0,0,1,3,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
            ],
            // Level 26: Central Column
            [
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
                [1,2,0,0,0,0,0,0,0,0,0,0,0,0,1],
                [1,1,1,1,1,1,1,0,1,1,1,1,1,0,1],
                [1,0,0,0,0,0,0,0,0,0,0,0,1,0,1],
                [1,0,1,1,1,1,1,0,1,1,1,0,1,0,1],
                [1,0,0,0,0,0,0,0,0,0,1,0,1,0,1],
                [1,1,1,1,1,1,1,0,1,0,1,0,1,0,1],
                [1,0,0,0,0,0,0,0,0,0,0,0,1,0,1],
                [1,0,1,1,1,1,1,1,1,1,1,1,1,1,1],
                [1,0,0,0,0,0,0,0,0,0,0,0,0,3,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
            ],
            // Level 27: ZigZag Walls
            [
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
                [1,2,0,0,0,1,0,1,0,1,0,1,0,0,1],
                [1,0,0,1,0,1,0,1,0,1,0,1,1,0,1],
                [1,0,1,1,0,0,0,1,0,1,0,0,0,0,1],
                [1,0,0,0,0,1,0,1,0,1,1,1,1,1,1],
                [1,0,1,1,1,1,0,1,0,0,0,0,0,0,1],
                [1,0,0,0,0,0,0,1,1,1,1,1,1,0,1],
                [1,1,1,1,1,1,0,1,0,0,0,0,0,0,1],
                [1,0,0,0,0,0,0,0,0,1,1,1,1,0,1],
                [1,0,1,1,1,1,1,1,0,0,1,0,0,3,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
            ],
            // Level 28: Small Islands
            [
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
                [1,2,0,0,1,0,0,0,1,0,0,0,1,0,1],
                [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1],
                [1,0,1,0,0,0,1,0,1,0,1,0,1,0,1],
                [1,0,1,1,1,1,1,1,1,0,1,1,1,0,1],
                [1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,0,1],
                [1,0,0,0,1,0,0,0,1,0,0,0,1,0,1],
                [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1],
                [1,0,1,0,0,0,1,0,0,0,1,0,0,3,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
            ],
            // Level 29: Inverse Labyrinth
            [
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
                [1,2,0,0,0,0,0,0,0,0,0,0,0,0,1],
                [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1],
                [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1],
                [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1],
                [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1],
                [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1],
                [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1],
                [1,0,1,0,1,0,1,0,1,1,1,0,1,1,1],
                [1,0,0,0,0,0,0,0,1,0,0,0,0,3,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
            ],
            // Level 30: Grand Finale (Complex)
            [
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
                [1,2,0,1,0,0,0,0,0,1,0,0,0,0,1],
                [1,1,0,1,0,1,1,1,0,1,0,1,1,0,1],
                [1,0,0,1,0,1,0,0,0,1,0,0,1,0,1],
                [1,0,1,1,0,1,0,1,1,1,1,0,1,0,1],
                [1,0,0,0,0,0,0,0,0,0,0,0,1,0,1],
                [1,0,1,1,1,1,1,1,1,1,1,0,1,0,1],
                [1,0,0,0,0,0,0,0,0,0,1,0,1,0,1],
                [1,0,1,1,1,1,1,0,1,0,1,0,1,0,1],
                [1,0,0,0,0,0,0,0,1,0,1,0,0,3,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
            ]
        ];

        // ------------------------- //
        // --- GLOBAL GAME STATE --- //
        // ------------------------- //
        
        const gameState = {
            mode: 'menu', // 'menu', '1p', '2p'
            gameActive: false,
            cellSize: 35, // Must match CSS :root
            p1: {
                x: 1, y: 1,
                el: null,
                fogEl: null,
                viewEl: document.getElementById('player1-view'),
                uiEl: document.getElementById('p1-ui'),
                mazeData: null,
                color: 'var(--color-p1)',
                glow: 'var(--color-p1-glow)'
            },
            p2: {
                x: 1, y: 1,
                el: null,
                fogEl: null,
                viewEl: document.getElementById('player2-view'),
                uiEl: document.getElementById('p2-ui'),
                mazeData: null,
                color: 'var(--color-p2)',
                glow: 'var(--color-p2-glow)'
            },
            singlePlayerLevel: 0
        };

        // DOM Elements
        const mainMenu = document.getElementById('main-menu');
        const gameContainer = document.getElementById('game-container');
        const splitScreenContainer = document.getElementById('split-screen-container');
        const messageScreen = document.getElementById('message-screen');
        
        // ------------------------- //
        // --- GAME SETUP & DRAWING --- //
        // ------------------------- //
        
        function initGame(mode) {
            gameState.mode = mode;
            gameState.gameActive = true;
            mainMenu.style.display = 'none';
            gameContainer.style.display = 'block';
            messageScreen.style.display = 'none';
            
            // CSS adjustment for cell size
            const root = document.documentElement;
            const screenHeight = window.innerHeight;
            const screenWidth = window.innerWidth;

            // Calculate cell size (simple, based on first maze)
            const maze = MAZE_DATA[0];
            const mazeH = maze.length;
            const mazeW = maze[0].length;
            
            let hCellSize, vCellSize;
            
            if (mode === '1p') {
                hCellSize = screenWidth / (mazeW + 2);
                vCellSize = screenHeight / (mazeH + 2);
                gameState.p1.viewEl.classList.add('single-player');
                gameState.p2.viewEl.style.display = 'none';
            } else {
                // Split-screen (horizontal layout)
                const viewWidth = screenWidth / 2;
                const viewHeight = (screenWidth > 800) ? screenHeight : screenHeight / 2;
                hCellSize = viewWidth / (mazeW + 2);
                vCellSize = viewHeight / (mazeH + 2);
                
                gameState.p1.viewEl.classList.remove('single-player');
                gameState.p2.viewEl.style.display = 'flex';
            }
            
            // Update cell size
            // We'll keep a fixed size for simplicity
            gameState.cellSize = parseInt(getComputedStyle(root).getPropertyValue('--cell-size')) || 35;
            root.style.setProperty('--cell-size', `${gameState.cellSize}px`);

            // Setup Player 1
            let p1MazeIndex;
            if (mode === '1p') {
                p1MazeIndex = gameState.singlePlayerLevel;
            } else {
                p1MazeIndex = Math.floor(Math.random() * MAZE_DATA.length);
            }
            gameState.p1.mazeData = MAZE_DATA[p1MazeIndex];
            setupPlayerView('p1', gameState.p1.mazeData, p1MazeIndex + 1);
            
            // Setup Player 2 (if 2P)
            if (mode === '2p') {
                // P2 gets a random maze
                const p2MazeIndex = Math.floor(Math.random() * MAZE_DATA.length);
                gameState.p2.mazeData = MAZE_DATA[p2MazeIndex];
                setupPlayerView('p2', gameState.p2.mazeData, p2MazeIndex + 1);
            }
        }
        
        function setupPlayerView(playerId, mazeData, levelIndex) {
            const player = gameState[playerId];
            player.viewEl.innerHTML = ''; // Clear view
            
            // 1. Create UI
            player.uiEl = document.createElement('div');
            player.uiEl.id = `${playerId}-ui`;
            player.uiEl.className = 'game-ui-overlay';
            player.uiEl.style.color = player.color;
            player.uiEl.textContent = (gameState.mode === '1p') ? `Level: ${levelIndex} / ${MAZE_DATA.length}` : ' Race! ';
            player.viewEl.appendChild(player.uiEl);

            // 2. Create Grid
            const grid = document.createElement('div');
            grid.className = 'grid-container';
            grid.style.gridTemplateColumns = `repeat(${mazeData[0].length}, 1fr)`;
            
            let startPos = { x: 1, y: 1 };

            mazeData.forEach((row, y) => {
                row.forEach((cellType, x) => {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    if (cellType === 1) cell.classList.add('wall');
                    if (cellType === 2) {
                        cell.classList.add('start');
                        startPos = { x, y };
                    }
                    if (cellType === 3) cell.classList.add('goal');
                    grid.appendChild(cell);
                });
            });
            player.viewEl.appendChild(grid);
            
            // 3. Create Player
            player.el = document.createElement('div');
            player.el.id = `player${playerId === 'p1' ? '1' : '2'}`;
            player.el.className = 'player';
            
            const avatar = document.createElement('div');
            avatar.className = 'player-avatar';
            player.el.appendChild(avatar);
            grid.appendChild(player.el); // Player is a child of grid for positioning
            
            // 4. Create Fog of War
            player.fogEl = document.createElement('div');
            player.fogEl.id = `${playerId}-fog`;
            player.fogEl.className = 'fog-of-war';
            // Fog is a child of .game-wrapper, not the grid
            player.viewEl.appendChild(player.fogEl); 

            // 5. Initialize position
            player.x = startPos.x;
            player.y = startPos.y;
            updatePlayerPosition(playerId, startPos.x, startPos.y, true); // true = force update
        }

        // ------------------------- //
        // --- PLAYER MOVEMENT & LOGIC --- //
        // ------------------------- //
        
        function handleKeyDown(e) {
            if (!gameState.gameActive) return;

            // Χρησιμοποιούμε το e.code για να πιάνει το κουμπί ανεξαρτήτως γλώσσας (Ελληνικά/Αγγλικά)
            const p1Keys = ['KeyW', 'KeyA', 'KeyS', 'KeyD'];
            const arrowKeys = ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'];

            // Αποτροπή scrolling αν πατηθεί κουμπί παιχνιδιού
            if ([...p1Keys, ...arrowKeys].includes(e.code)) {
                e.preventDefault();
            }

            // ---------- PLAYER 1 (WASD + Arrows στο 1P) ----------
            if (gameState.mode === '1p') {
                if (e.code === 'KeyW' || e.code === 'ArrowUp') movePlayer('p1', 0, -1);
                else if (e.code === 'KeyS' || e.code === 'ArrowDown') movePlayer('p1', 0, 1);
                else if (e.code === 'KeyA' || e.code === 'ArrowLeft') movePlayer('p1', -1, 0);
                else if (e.code === 'KeyD' || e.code === 'ArrowRight') movePlayer('p1', 1, 0);
            }

            if (gameState.mode === '2p') {
                // P1 = WASD (Χρησιμοποιούμε e.code, άρα δουλεύει και με Ελληνικά)
                if (e.code === 'KeyW') movePlayer('p1', 0, -1);
                else if (e.code === 'KeyS') movePlayer('p1', 0, 1);
                else if (e.code === 'KeyA') movePlayer('p1', -1, 0);
                else if (e.code === 'KeyD') movePlayer('p1', 1, 0);

                // ---------- PLAYER 2 (ONLY ARROW KEYS) ----------
                if (e.code === 'ArrowUp') movePlayer('p2', 0, -1);
                else if (e.code === 'ArrowDown') movePlayer('p2', 0, 1);
                else if (e.code === 'ArrowLeft') movePlayer('p2', -1, 0);
                else if (e.code === 'ArrowRight') movePlayer('p2', 1, 0);
            }
        }
        
        function movePlayer(playerId, dx, dy) {
            const player = gameState[playerId];
            if (!player.mazeData) return; // Player inactive
            
            const newX = player.x + dx;
            const newY = player.y + dy;
            
            // Check boundaries
            if (newY < 0 || newY >= player.mazeData.length || newX < 0 || newX >= player.mazeData[0].length) {
                return;
            }

            const targetCell = player.mazeData[newY][newX];

            // 1. Wall Check (Collision)
            if (targetCell === 1) {
                playSparkVFX(playerId, player.x, player.y, dx, dy);
                return;
            }

            // 2. Valid Move
            updatePlayerPosition(playerId, newX, newY);
            playStepVFX(playerId);
            leaveGlowTrail(playerId);
            
            // 3. Win Check
            if (targetCell === 3) {
                handleWin(playerId);
            }
        }
        
        function updatePlayerPosition(playerId, newX, newY, force = false) {
            const player = gameState[playerId];
            if (!force && player.x === newX && player.y === newY) return; // Didn't move
            
            player.x = newX;
            player.y = newY;
            
            const pixelX = newX * gameState.cellSize;
            const pixelY = newY * gameState.cellSize;
            
            // 1. Move Player DOM
            player.el.style.transform = `translate(${pixelX}px, ${pixelY}px) translateZ(5px)`;
            
            // 2. Update Fog of War
            // Light must be in player's center
            const lightX = pixelX + (gameState.cellSize / 2);
            const lightY = pixelY + (gameState.cellSize / 2);
            
            const cssVarX = `--${playerId}-light-x`;
            const cssVarY = `--${playerId}-light-y`;
            
            // fogEl is child of viewEl, so coordinates are correct
            // We need coordinates relative to .game-wrapper
            const gridRect = player.el.parentElement.getBoundingClientRect();
            const viewRect = player.viewEl.getBoundingClientRect();
            
            // Relative position of grid inside view
            const gridOffsetX = gridRect.left - viewRect.left;
            const gridOffsetY = gridRect.top - viewRect.top;

            const fogLightX = gridOffsetX + lightX;
            const fogLightY = gridOffsetY + lightY;

            // We use CSS variables on :root for the fog to find
            document.documentElement.style.setProperty(cssVarX, `${fogLightX}px`);
            document.documentElement.style.setProperty(cssVarY, `${fogLightY}px`);
        }

        // ------------------------- //
        // --- VISUAL EFFECTS (VFX) --- //
        // ------------------------- //

        function createParticle(container, x, y, className, color, glow) {
            const p = document.createElement('div');
            p.className = `particle ${className}`;
            p.style.left = `${x}px`;
            p.style.top = `${y}px`;
            p.style.background = color;
            p.style.boxShadow = `0 0 5px ${glow}, 0 0 10px ${glow}`;
            
            container.appendChild(p);
            
            // Cleanup after animation
            p.addEventListener('animationend', () => {
                p.remove();
            });
            return p;
        }

        // VFX 1: Step (at player center)
        function playStepVFX(playerId) {
            const player = gameState[playerId];
            const pRect = player.el.getBoundingClientRect(); // Position on screen
            const vRect = player.viewEl.getBoundingClientRect(); // View position

            // Relative position inside view
            const x = pRect.left - vRect.left + (pRect.width / 2);
            const y = pRect.top - vRect.top + (pRect.height / 2);
            
            for (let i = 0; i < 3; i++) { // 3 particles
                const p = createParticle(player.viewEl, x, y, 'step-particle', player.color, player.glow);
                p.style.setProperty('--dx', (Math.random() - 0.5) * 30);
                p.style.setProperty('--dy', (Math.random() - 0.5) * 30);
            }
        }
        
        // VFX 2: Trail (at player center)
        function leaveGlowTrail(playerId) {
             const player = gameState[playerId];
             const pRect = player.el.getBoundingClientRect();
             const vRect = player.viewEl.getBoundingClientRect();
             const x = pRect.left - vRect.left + (pRect.width / 2);
             const y = pRect.top - vRect.top + (pRect.height / 2);

            createParticle(player.viewEl, x - 5, y - 5, 'glow-trail', player.color, player.glow);
        }
        
        // VFX 3: Spark (at collision point)
        function playSparkVFX(playerId, playerX, playerY, dx, dy) {
            const player = gameState[playerId];
            const pRect = player.el.getBoundingClientRect();
            const vRect = player.viewEl.getBoundingClientRect();
            
            // Calculate collision point
            const sparkX = (pRect.left - vRect.left + pRect.width / 2) + (dx * gameState.cellSize / 2.2);
            const sparkY = (pRect.top - vRect.top + pRect.height / 2) + (dy * gameState.cellSize / 2.2);

            for (let i = 0; i < 5; i++) { // 5 sparks
                const p = createParticle(player.viewEl, sparkX, sparkY, 'spark-particle', '#FFFF00', 'rgba(255,255,0,0.7)');
                // Sparks fly backwards
                p.style.setProperty('--dx', (Math.random() - 0.5) * 40 - (dx * 20));
                p.style.setProperty('--dy', (Math.random() - 0.5) * 40 - (dy * 20));
            }
        }

        // ------------------------- //
        // --- GAME FLOW & WIN/LOSS --- //
        // ------------------------- //
        
        function handleWin(winnerId) {
            gameState.gameActive = false;
            const winner = gameState[winnerId];
            
            const msgTitle = document.getElementById('message-title');
            const msgText = document.getElementById('message-text');
            const nextBtn = document.getElementById('next-level-button');
            const againBtn = document.getElementById('play-again-button');
            
            if (gameState.mode === '1p') {
                gameState.singlePlayerLevel++;
                
                if (gameState.singlePlayerLevel >= MAZE_DATA.length) {
                    // Game over (All mazes finished)
                    msgTitle.textContent = 'GAME MASTER!';
                    msgText.textContent = `You finished all ${MAZE_DATA.length} mazes! A true Maze of Echoes champion.`;
                    msgTitle.style.color = 'var(--color-goal)';
                    nextBtn.style.display = 'none';
                } else {
                    msgTitle.textContent = 'LEVEL COMPLETE!';
                    msgText.textContent = `Proceeding to level ${gameState.singlePlayerLevel + 1}`;
                    msgTitle.style.color = 'var(--color-p1)';
                    nextBtn.style.display = 'block';
                }
                againBtn.style.display = 'none';
                
            } else if (gameState.mode === '2p') {
                const winnerName = (winnerId === 'p1') ? 'Player 1 (Cyan)' : 'Player 2 (Magenta)';
                msgTitle.textContent = 'WINNER!';
                msgTitle.style.color = winner.color;
                msgText.textContent = `${winnerName} wins the race!`;
                
                nextBtn.style.display = 'none';
                againBtn.style.display = 'block';
            }
            
            messageScreen.style.display = 'flex';
        }

        function resetToMenu() {
            gameState.mode = 'menu';
            gameState.gameActive = false;
            gameState.singlePlayerLevel = 0;
            mainMenu.style.display = 'flex';
            gameContainer.style.display = 'none';
            messageScreen.style.display = 'none';
            
            // Clear views
            gameState.p1.viewEl.innerHTML = '';
            gameState.p2.viewEl.innerHTML = '';
            document.documentElement.style.setProperty('--p1-light-x', `50%`);
            document.documentElement.style.setProperty('--p1-light-y', `50%`);
            document.documentElement.style.setProperty('--p2-light-x', `50%`);
            document.documentElement.style.setProperty('--p2-light-y', `50%`);
        }

        // ------------------------- //
        // --- EVENT LISTENERS --- //
        // ------------------------- //
        
        // Menu Buttons
        document.getElementById('start-1p').addEventListener('click', () => {
            gameState.singlePlayerLevel = 0; // Start from level 1
            initGame('1p');
        });
        document.getElementById('start-2p').addEventListener('click', () => initGame('2p'));
        
        // Message Screen Buttons
        document.getElementById('next-level-button').addEventListener('click', () => {
             // singlePlayerLevel was already incremented in handleWin
             initGame('1p');
        });
        document.getElementById('play-again-button').addEventListener('click', () => {
            initGame('2p'); // Starts new 2P
        });
        document.getElementById('main-menu-button').addEventListener('click', resetToMenu);

        // Global Key Listener
        document.addEventListener('keydown', handleKeyDown);
        
        // Recalculate size/position on resize
        window.addEventListener('resize', () => {
            if (gameState.gameActive) {
                // Restart current level to adjust everything
                if(gameState.mode === '1p') {
                    // Decrement to keep on the same level index before re-init
                    const currentLevel = gameState.singlePlayerLevel > 0 ? gameState.singlePlayerLevel - 1 : 0;
                    gameState.singlePlayerLevel = currentLevel;
                    initGame('1p'); 
                } else if (gameState.mode === '2p') {
                    initGame('2p');
                }
            }
        });

        // ------------------------- //
        // --- MOBILE DETECTION --- //
        // ------------------------- //
        
        function isMobileDevice() {
            // Ελέγχει αν η οθόνη είναι μικρή (<= 800px) ΚΑΙ έχει δυνατότητα αφής (touch)
            const isSmallScreen = window.matchMedia("(max-width: 800px)").matches;
            const isTouch = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0) || (navigator.msMaxTouchPoints > 0);

            // Θεωρούμε "mobile" ό,τι είναι μικρή οθόνη με δυνατότητα αφής
            return isSmallScreen && isTouch;
        }

        function checkMobileSupport() {
            const mobileMessage = document.getElementById('mobile-unsupported-message');
            const mainMenu = document.getElementById('main-menu');
            const gameContainer = document.getElementById('game-container');

            if (isMobileDevice()) {
                // Εάν είναι mobile:
                
                // 1. Απόκρυψη όλων των στοιχείων του παιχνιδιού
                mainMenu.style.display = 'none';
                gameContainer.style.display = 'none';
                
                // 2. Εμφάνιση του μηνύματος μη υποστήριξης
                mobileMessage.style.display = 'flex';
                
                // 3. Απενεργοποίηση της λογικής του παιχνιδιού
                gameState.mode = 'unsupported'; 
                gameState.gameActive = false;
                
                // 4. Αφαίρεση του keydown listener για να μην λειτουργεί το πληκτρολόγιο
                document.removeEventListener('keydown', handleKeyDown);
            }
            // Εάν ΔΕΝ είναι mobile, η συνάρτηση απλώς τελειώνει, αφήνοντας το παιχνίδι να φορτώσει κανονικά.
        }
        
        // Εκτέλεση του ελέγχου αμέσως μόλις φορτώσει η σελίδα
        checkMobileSupport();

    </script>
</body>
</html>